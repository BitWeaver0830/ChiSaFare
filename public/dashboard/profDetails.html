<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Profile - Chi Sa Fare</title>
    <meta name="description" content="Pannello di controllo Chi Sa Fare">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&amp;display=swap">
    <link rel="stylesheet" href="assets/fonts/fontawesome-all.min.css">

    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://code.jquery.com/jquery-3.7.0.js"
        integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>
    <script src="./assets/js/header.js"></script>

    <script src="./assets/js/checkLogin.js"></script>
    <script src="./assets/js/profDetails.js"></script>

</head>

<body id="page-top">
    <div id="wrapper">
        <nav id="header" class="navbar navbar-dark align-items-start sidebar accordion bg-custom p-0">
        </nav>
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <nav id="topPage" class="navbar navbar-light navbar-expand bg-white shadow mb-4 topbar static-top">
                </nav>
                <div class="container-fluid">
                    <h3 class="text-dark mb-4">Profilo - <span class="ragione_sociale">Commercialista</span> <span
                            id="status"></span></h3>
                    <div class="row mb-3">
                        <div class="col">
                            <div class="row">
                                <div class="col">
                                    <div class="card shadow mb-3">
                                        <div class="card-header py-3">
                                            <p class="text-primary m-0 fw-bold">Dati Professionista</p>
                                        </div>
                                        <div class="card-body">
                                            <form id="updatePro">

                                                <div class="row">
                                                    <div class="col">
                                                        <div class="mb-3"><label class="form-label"
                                                                for="ragione_sociale"><strong>Ragione
                                                                    Sociale</strong></label><input class="form-control"
                                                                type="text" id="ragione_sociale"
                                                                placeholder="Ragione sociale" name="ragione_sociale">
                                                        </div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="mb-3"><label class="form-label"
                                                                for="p_iva"><strong>P.Iva</strong></label><input
                                                                class="form-control" type="text" id="p_Iva"
                                                                placeholder="P.Iva" name="p_iva"></div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col">
                                                        <div class="mb-3"><label class="form-label"
                                                                for="indirizzo_azienda"><strong>Indirizzo</strong></label><input
                                                                class="form-control" type="text" id="indirizzo_azienda"
                                                                placeholder="Indirizzo Azienda"
                                                                name="indirizzo_azienda"></div>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col">
                                                        <div class="mb-3"><label class="form-label"
                                                                for="citta_azienda"><strong>Città</strong></label><input
                                                                class="form-control" type="text" id="citta_azienda"
                                                                placeholder="Città" name="citta_azienda"></div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="mb-3"><label class="form-label"
                                                                for="provincia_azienda"><strong>Provincia</strong></label><input
                                                                class="form-control" type="text" id="provincia_azienda"
                                                                placeholder="Provincia" name="provincia_azienda"></div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="mb-3"><label class="form-label"
                                                                for="cap_azienda"><strong>CAP</strong></label><input
                                                                class="form-control" type="text" id="cap_azienda"
                                                                placeholder="CAP" name="cap_azienda"></div>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col">
                                                        <div class="mb-3">
                                                            <label class="form-label" for="Ateco"><strong>Codice
                                                                    Ateco</strong></label>
                                                            <select class="form-control" id="ateco_azienda"
                                                                placeholder="Codice Ateco Azienda" name="ateco_azienda">
                                                                <option value="">Seleziona un codice Ateco
                                                                </option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>


                                                <div class="row">
                                                    <div class="col">
                                                        <div class="mb-3"><label class="form-label"
                                                                for="email_azienda"><strong>Email</strong></label><input
                                                                class="form-control" type="email" id="email_azienda"
                                                                placeholder="Email Azienda" name="email_azienda"
                                                                disabled>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col">
                                                        <div class="mt-3 tag-container">
                                                            <div class="wrapper rounded">
                                                                <div class="title d-flex align-items-center">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16"
                                                                        height="16" fill="currentColor"
                                                                        class="bi bi-tag-fill" viewBox="0 0 16 16">
                                                                        <path
                                                                            d="M2 1a1 1 0 0 0-1 1v4.586a1 1 0 0 0 .293.707l7 7a1 1 0 0 0 1.414 0l4.586-4.586a1 1 0 0 0 0-1.414l-7-7A1 1 0 0 0 6.586 1zm4 3.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0" />
                                                                    </svg>

                                                                    <label class="ms-2">Tag</label>
                                                                </div>
                                                                <script>

                                                                </script>
                                                                <div class="content">

                                                                    <div class="tag-input" required>

                                                                        <ul class="list-unstyled mb-3" id="selectedTags"></ul>

                                                                        <div class="form-group dropdown-content show"
                                                                            id="myDropdown">
                                                                            <input class="form-control" list="questions"
                                                                                id="securityQuestionInput"
                                                                                placeholder="Aggiungere etichette"
                                                                                onkeyup="filterFunction()"
                                                                                oninput="fetchSecurityQuestions(this.value)" />

                                                                            <datalist class="d-block" id="taglist"></datalist>

                                                                        </div>

                                                                    </div>


                                                                    <div class="details d-flex justify-content-end"
                                                                        style="padding: 2%; gap: 5px;" required>
                                                                        <button class="btn btn-primary btn-hover mr-3"
                                                                            onclick="addTagFromInput()">Aggiungere</button>
                                                                        <button class="btn btn-primary btn-hover mr-3"
                                                                            id="emptyTagsButton">Rimuovi</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col">
                                                        <div class="mb-3"><label class="form-label"
                                                                for="date-visura"><strong>Visura</strong></label><input
                                                                class="form-control" id="date-visura" type="date"
                                                                name="date-visura"></div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="mb-3"><label class="form-label"
                                                                for="date-durc"><strong>DURC</strong></label><input
                                                                class="form-control" id="date-durc" type="date"
                                                                name="date-durc"></div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="mb-3"><label class="form-label"
                                                                for="date-assicurazione"><strong>Assicurazione</strong></label><input
                                                                class="form-control" id="date-assicurazione" type="date"
                                                                name="date-assicurazione"></div>
                                                    </div>
                                                </div>
                                                <div class="messageBox"></div>
                                                <div class="mb-3"><button class="btn btn-primary btn-sm"
                                                        type="submit">Aggiorna</button>
                                                </div>

                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="bg-white sticky-footer">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span>Copyright © Chi Sa Fare 2023</span></div>
                </div>
            </footer>
        </div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initial setup
            fillAteco();

            // Prevent form submission on Enter key press
            const inputField = document.getElementById("add-pro");
            inputField && inputField.addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                }
            });

            const addTag0 = document.getElementById("securityQuestionInput");
            addTag0.addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    const inputValue = this.value.trim();
                    if (inputValue !== "") {
                        addTag(inputValue);
                        this.value = "";
                    }
                }
            });

            document.getElementById("emptyTagsButton").addEventListener("click", function (event) {
                event.preventDefault();
                emptySelectedTags();
            });

            document.getElementById("securityQuestionInput").addEventListener("change", function (event) {
                const selectedOption = event.target.value;
                if (selectedOption) {
                    addTag(selectedOption);
                    event.target.value = "";
                }
            });

            document.getElementById("securityQuestionInput").addEventListener("input", function () {
                const keyword = this.value.trim();
                if (keyword.length > 0) {
                    fetchSecurityQuestions(keyword);
                }
            });
        });

        let selectedTags = [];

        function fetchProfessional() {
            return new Promise(function (resolve, reject) {
                var url =
                    "/api/businessConsultant/getAllProfessionals";

                $.ajax({
                    url: url,
                    type: "POST",
                    dataType: "json",
                    headers: {
                        bcID: localStorage.getItem("id"),
                        token: localStorage.getItem("dashboard-token"),
                    },
                })
                    .done(function (data) {
                        const urlParams = new URLSearchParams(window.location.search);
                        const id = urlParams.get("id");
                        resolve(data);
                        var professionist;
                        data.professionals.forEach((element) => {
                            if (element._id == id) {
                                professionist = element;
                            }
                        });
                        professionist.tags.forEach(item => {
                            selectedTags.push(item)
                        })

                        const selectedTagsList = document.getElementById("selectedTags");

                        selectedTagsList.innerHTML = "";

                        selectedTags.forEach((tag) => {
                            const listItem = document.createElement("li");
                            listItem.style.marginBottom = "5px";

                            const tagSpan = document.createElement("span");
                            tagSpan.textContent = tag;
                            tagSpan.style.padding = "5px";
                            tagSpan.style.borderRadius = "5px";
                            listItem.appendChild(tagSpan);

                            const removeButton = document.createElement("button");
                            removeButton.innerHTML = `&nbsp;-&nbsp;`;
                            removeButton.style.backgroundColor = "#FF9800";
                            removeButton.style.color = "#ffffff";
                            removeButton.style.border = "none";
                            removeButton.style.borderRadius = "50%";
                            removeButton.style.marginLeft = "5px";
                            removeButton.style.cursor = "pointer";
                            removeButton.addEventListener("click", () => removeTag(tag));
                            listItem.appendChild(removeButton);

                            selectedTagsList.appendChild(listItem);
                        });

                    })
                    .fail(function (error) {
                        alert("Errore nel caricamento dei dati");
                        reject(error);
                    });
            });
        }


        function fetchSecurityQuestions() {
            return new Promise(function (resolve, reject) {
                var url = "/api/tags?${keyword && 'search=' + keyword}";

                $.ajax({
                    url: url,
                    type: "Get",
                    contentType: "application/json",
                })
                .done(function (data) {
                    const taglist = document.getElementById('taglist');
                    taglist.innerHTML = "";
                    data.forEach((item) => {
                    const opt = document.createElement('a');
                    opt.href = '#';
                    opt.innerHTML = item.tag;
                    opt.setAttribute("onclick", `addTag('${item.tag}')`);
                    taglist.appendChild(opt);
                    });
                })
                .fail((res) => {
                    if (!response.ok) {
                    throw new Error("Network response was not ok");
                    }
                    return response.json();
                });
      });
    }
        fetchSecurityQuestions("t")
        updateSelectedTags()
        initialFun()

        function initialFun() {
            const selectData = $("#selectedTags").val()

            const selectedTagsList = document.getElementById("selectedTags");
        }


        function addTag(tag) {

            const findData = selectedTags && selectedTags?.length > 0 && selectedTags?.find((item) => item == tag);

            if (!findData) {
                selectedTags.push(tag);
                updateSelectedTags();
            }
        }

        function addTagFromInput() {
            const inputValue = document.getElementById("securityQuestionInput").value.trim();
            if (inputValue !== "") {
                addTag(inputValue);
                document.getElementById("securityQuestionInput").value = "";
            }
        }

        function removeTag(tag) {
            const index = selectedTags.indexOf(tag);
            if (index !== -1) {
                selectedTags.splice(index, 1);
                updateSelectedTags();
            }
        }

        function emptySelectedTags() {
            selectedTags = [];
            updateSelectedTags();
        }

        function updateSelectedTags() {

            const selectedTagsList = document.getElementById("selectedTags");

            selectedTagsList.innerHTML = "";

            selectedTags.forEach((tag) => {
                const listItem = document.createElement("li");
                listItem.style.marginBottom = "5px";

                const tagSpan = document.createElement("span");
                tagSpan.textContent = tag;
                tagSpan.style.padding = "5px";
                tagSpan.style.borderRadius = "5px";
                listItem.appendChild(tagSpan);

                const removeButton = document.createElement("button");
                removeButton.innerHTML = `&nbsp;-&nbsp;`;
                removeButton.style.backgroundColor = "#FF9800";
                removeButton.style.color = "#ffffff";
                removeButton.style.border = "none";
                removeButton.style.borderRadius = "50%";
                removeButton.style.marginLeft = "5px";
                removeButton.style.cursor = "pointer";
                removeButton.addEventListener("click", () => removeTag(tag));
                listItem.appendChild(removeButton);

                selectedTagsList.appendChild(listItem);
            });

        }

        function filterFunction() {
            const input = document.getElementById("securityQuestionInput");
            const filter = input.value.toUpperCase();
            const div = document.getElementById("myDropdown");
            const a = div.getElementsByTagName("a");
            for (let i = 0; i < a.length; i++) {
                const txtValue = a[i].textContent || a[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    a[i].style.display = "";
                } else {
                    a[i].style.display = "none";
                }
            }
        }
    </script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="assets/js/theme.js"></script>
</body>

</html>